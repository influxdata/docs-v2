# Production Link Checker Configuration for InfluxData docs-v2
# Updated for link-checker v1.3.1 with severity-based classification
#
# With severity levels, we no longer need to exclude sites that return:
# - 403/401/429 (classified as "info" - shown but don't fail CI)
# - 5xx/timeout (classified as "warning" - shown but don't fail CI)
# Only 404/410/DNS failures are classified as "error" and fail CI.

[lychee]
# Performance settings
max_retries = 3
timeout = 30
max_concurrency = 128
skip_code_blocks = false

# HTTP settings
"User-Agent" = "Mozilla/5.0 (compatible; influxdata-link-checker/1.3; +https://github.com/influxdata/docs-v2)"
accept = [200, 201, 202, 203, 204, 206, 301, 302, 303, 304, 307, 308]

# Skip these URL schemes
scheme = ["mailto", "tel"]

# Performance optimizations
cache = true
max_cache_age = "1h"

# Retry configuration for reliability
include_verbatim = false

# Exclusion patterns for docs-v2 (regex supported)
# NOTE: With v1.3.0 severity classification, we only need to exclude:
# - Non-HTTP URLs (localhost, local networks)
# - Placeholder/example URLs
# - Known false positives (not HTTP status related)
# - CI-specific workarounds
exclude = [
  # Localhost and local network URLs
  "^https?://localhost",
  "^https?://127\\.0\\.0\\.1",
  "^https?://.*\\.local",

  # Example domains used in documentation
  "^https?://example\\.(com|org|net)",

  # Placeholder URLs from code block filtering
  "https://example.com/REMOVED_FROM_CODE_BLOCK",
  "example.com/INLINE_CODE_URL",

  # Production site URLs (when testing locally, these should be relative)
  # This excludes canonical URLs and other absolute production URLs
  # TODO: Remove after fixing canonical URL generation or link-checker domain replacement
  "^https://docs\\.influxdata\\.com/",

  # Local file URLs with fragments â€” lychee resolves /path/to/page#fragment to
  # file:///path/to/page#fragment, but the actual file is at /path/to/page/index.html.
  # This causes false "Cannot find file" errors for valid pages with Hugo pretty URLs.
  # NOTE: This also means lychee CANNOT validate fragments on local files.
  # Fragment validation for internal links is a known gap (lychee doesn't open
  # index.html to check heading anchors).
  "^file://.*#",

  # Common documentation placeholders
  "YOUR_.*",
  "REPLACE_.*",
  "<.*>",
]

# Request headers (help avoid bot detection on some sites)
[headers]
"Accept" = "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
"Accept-Language" = "en-US,en;q=0.5"
"Accept-Encoding" = "gzip, deflate"
"DNT" = "1"
"Connection" = "keep-alive"
"Upgrade-Insecure-Requests" = "1"

# Severity classification (link-checker v1.3.0+)
# These settings control which HTTP status codes fail CI vs show as warnings/info
[severity]
# Error codes fail CI - genuine broken links
error_codes = [404, 410]

# Warning codes are shown but don't fail CI - transient issues
warning_codes = [500, 502, 503, 504]

# Info codes are low priority - access restrictions, bot protection
info_codes = [401, 403, 429]

# Set to true to treat warnings as errors (stricter validation)
# NOTE: Missing local files (file-not-found) have no HTTP status code and
# default to "warning" severity. The workflow reclassifies these as errors.
strict = false

[ci]
# CI-specific settings

[ci.github_actions]
output_format = "json"
create_annotations = true
fail_fast = false
max_annotations = 50  # Limit to avoid overwhelming PR comments

[ci.performance]
# Performance tuning for CI environment
parallel_requests = 32
connection_timeout = 10
read_timeout = 30

# Resource limits
max_memory_mb = 512
max_execution_time_minutes = 10

[reporting]
# Report configuration
# NOTE: lychee's --include-fragments does not validate fragments on local file
# URLs. It only works for HTTP responses. Set to false to avoid confusion.
include_fragments = false
verbose = false
no_progress = true  # Disable progress bar in CI

# Summary settings
show_success_count = true
show_skipped_count = true
