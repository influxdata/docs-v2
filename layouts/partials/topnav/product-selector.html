{{ $scratch := newScratch }}
{{ $productPathData := split .RelPermalink "/" }}
{{ $product := index $productPathData 0 }}
{{ $currentVersion := index $productPathData 1 }}
{{ $pageRoot := print $product "/" $currentVersion }}
{{ $isCloud := eq $pageRoot "influxdb/cloud" }}
{{ $isCore := in $pageRoot "influxdb3/core" }}
{{ $isEnterprise := in $pageRoot "influxdb3/enterprise" }}
{{ $isServerless := eq $pageRoot "influxdb3/cloud-serverless" }}
{{ $isDedicated := eq $pageRoot "influxdb3/cloud-dedicated" }}
{{ $isClustered := eq $pageRoot "influxdb3/clustered" }}
{{ $altLinks := .Page.Params.alt_links | default dict }}
{{ $isInfluxDB3 := or $isCore $isEnterprise $isServerless $isDedicated $isClustered }}
{{ $sortedProducts := sort .Site.Data.products "list_order" "asc"}}

{{/* //////////////////// INFLUXDB PRODUCT DICTIONARIES /////////////////// */}}
{{ $ossInfo := dict $.Site.Data.products.influxdb.name (dict "path" (print "influxdb/" (replaceRE `\..*` "" $.Site.Data.products.influxdb.latest)) "key" "oss") }}
{{ $coreInfo := dict $.Site.Data.products.influxdb3_core.name (dict "path" "influxdb3/core" "key" "core") }}
{{ $enterpriseInfo := dict $.Site.Data.products.influxdb3_enterprise.name (dict "path" "influxdb3/enterprise" "key" "enterprise") }}
{{ $cloudInfo := dict $.Site.Data.products.influxdb_cloud.name (dict "path" "influxdb/cloud" "key" "cloud") }}
{{ $serverlessInfo := dict $.Site.Data.products.influxdb3_cloud_serverless.name (dict "path" "influxdb3/cloud-serverless" "key" "cloud-serverless") }}
{{ $dedicatedInfo := dict $.Site.Data.products.influxdb3_cloud_dedicated.name (dict "path" "influxdb3/cloud-dedicated" "key" "cloud-dedicated") }}
{{ $clusteredInfo := dict $.Site.Data.products.influxdb3_clustered.name (dict "path" "influxdb3/clustered" "key" "clustered") }}
{{ $influxdbInfo := merge $ossInfo $coreInfo $enterpriseInfo $cloudInfo $serverlessInfo $dedicatedInfo $clusteredInfo }}

<div class="dropdown">
  {{ if or (eq $product nil) (eq $product "platform") (eq $product "resources") }}
    <p class="selected">Select product</p>
  {{ else }}
    {{ $scratch.Set "displayName" "" }}
    {{ if $isCloud }}{{ $scratch.Set "displayName" $.Site.Data.products.influxdb_cloud.name}}
    {{ else if $isCore }}{{ $scratch.Set "displayName" $.Site.Data.products.influxdb3_core.name }}
    {{ else if $isEnterprise }}{{ $scratch.Set "displayName" $.Site.Data.products.influxdb3_enterprise.name }}
    {{ else if $isServerless }}{{ $scratch.Set "displayName" $.Site.Data.products.influxdb3_cloud_serverless.name }}
    {{ else if $isDedicated }}{{ $scratch.Set "displayName" $.Site.Data.products.influxdb3_cloud_dedicated.name }}
    {{ else if $isClustered }}{{ $scratch.Set "displayName" $.Site.Data.products.influxdb3_clustered.name }}
    {{ else }}
      {{ $productData := (index .Site.Data.products $product) }}
      {{ $scratch.Set "displayName" (cond (isset $productData "altname") $productData.altname $productData.name) }}
    {{ end }}
    {{ $displayName := $scratch.Get "displayName" }}
    <p class="selected">{{ $displayName }}</p>
  {{ end }}
  
  <ul class="item-list products" data-category="Managed">
    {{ range $sortedProducts }}
      {{ if eq .menu_category "managed" }}       
        {{ $isCurrentProduct := and (eq .namespace $product) (in .versions $currentVersion) }}       
        {{ if not $isCurrentProduct }}
          {{ $scratch.Set "link" (print "/" .namespace "/" (replaceRE `\..*` "" .latest) "/") }}

          {{ if eq $product "influxdb" }}
            {{ $replacementPath := index (index $influxdbInfo .name) "path" }}
            {{ $altProductPage := $.GetPage ((replaceRE $pageRoot $replacementPath $.Page.RelPermalink) | replaceRE `\/$` "") }}

            {{/* ///////////// GET DEFAULT ALT PAGE AT SAME PATH //////////// */}}
            {{ if gt (len $altProductPage.Title) 0 }}
              {{ $scratch.Set "link" $altProductPage.RelPermalink }}

            {{/* ////////////// GET ALT LINKS FROM FRONTMATTER ////////////// */}}
            {{ else if (gt (len $altLinks) 0) }}
              {{ $productKey := index (index $influxdbInfo .name) "key" | default "" }}
              {{ if isset $altLinks $productKey }}
                {{ $scratch.Set "link" (index $altLinks $productKey) }}
              {{ else if gt (len $altProductPage.Title) 0 }}
                {{ $scratch.Set "link" $altProductPage.RelPermalink }}
              {{ end }}
            {{ end }}        
          {{ end }}

        {{ else }}
          {{ $scratch.Set "link" "" }}
        {{ end }}
        {{ $link := $scratch.Get "link" }}
        <li>
          <a href='{{ $link }}' {{ if $isCurrentProduct }}class="active"{{ end }}>{{ .name }}</a>
        </li>
      {{ end }}
    {{ end }}
  </ul>
  <ul class="item-list products" data-category="Self-managed">
    {{ range $sortedProducts }}
      {{ if eq .menu_category "self-managed" }}
        {{ $isCurrentProduct := and (eq .namespace $product) (in .versions $currentVersion) }}

        {{ if not $isCurrentProduct }}
          {{ $scratch.Set "link" (print "/" .namespace "/" (replaceRE `\..*` "" .latest) "/") }}
                   
          {{ if and (eq $product "influxdb") (gt (len (findRE `^influxdb` .namespace)) 0) }}
            {{ $replacementPath := index (index $influxdbInfo .name) "path" }}
            {{ $altProductPage := $.GetPage ((replaceRE $pageRoot $replacementPath $.Page.RelPermalink) | replaceRE `\/$` "") }}

            {{/* ///////////// GET DEFAULT ALT PAGE AT SAME PATH //////////// */}}
            {{ if gt (len $altProductPage.Title) 0 }}
              {{ $scratch.Set "link" $altProductPage.RelPermalink }}

            {{/* ////////////// GET ALT LINKS FROM FRONTMATTER ////////////// */}}
            {{ else if (gt (len $altLinks) 0) }}
              {{ $productKey := index (index $influxdbInfo .name) "key" | default "" }}
              {{ if isset $altLinks $productKey }}
                {{ $scratch.Set "link" (index $altLinks $productKey) }}
              {{ end }}
            {{ end }}
          {{ end }}

        {{ else }}
          {{ $scratch.Set "link" "" }}
        {{ end }}

        {{ $link := $scratch.Get "link" }}
        <li>
          <a href='{{ $link }}' {{ if $isCurrentProduct }}class="active"{{ end }}>{{ if .altname }}{{.altname}}{{ else }}{{ .name }}{{ end }}</a>
        </li>
      {{ end }}
    {{ end }}
  </ul>
  <ul class="item-list products" data-category="Other products">
    {{ range $sortedProducts }}
      {{ if eq .menu_category "other" }}
        {{ $isCurrentProduct := and (eq .namespace $product) (in .versions $currentVersion) }}       
        {{ if not $isCurrentProduct }}
          {{ $scratch.Set "link" (print "/" .namespace "/" (replaceRE `\..*` "" .latest) "/") }}
          
          {{ if and (eq $product "influxdb") (gt (len (findRE `^influxdb` .namespace)) 0) }}
            {{ $replacementPath := index (index $influxdbInfo .name) "path" }}
            {{ $altProductPage := $.GetPage ((replaceRE $pageRoot $replacementPath $.Page.RelPermalink) | replaceRE `\/$` "") }}
            
            {{/* ///////////// GET DEFAULT ALT PAGE AT SAME PATH //////////// */}}
            {{ if gt (len $altProductPage.Title) 0 }}
              {{ $scratch.Set "link" $altProductPage.RelPermalink }} true

            {{/* ////////////// GET ALT LINKS FROM FRONTMATTER ////////////// */}}
            {{ else if (gt (len $altLinks) 0) }}
              {{ $productKey := index (index $influxdbInfo .name) "key" | default "" }}
              {{ if isset $altLinks $productKey }}
                {{ $scratch.Set "link" (index $altLinks $productKey) }}
              {{ end }}
            {{ end }}        
          {{ end }}

        {{ else }}
          {{ $scratch.Set "link" "" }}
        {{ end }}
        {{ $link := $scratch.Get "link" }}
        <li>
          <a href='{{ $link }}' {{ if $isCurrentProduct }}class="active"{{ end }}>{{ if .altname }}{{.altname}}{{ else }}{{ .name }}{{ end }}</a>
        </li>
      {{ end }}
    {{ end }}
  </ul>
  <ul class="item-list products" data-category="Languages">
    {{ range $sortedProducts }}
      {{ if eq .menu_category "languages" }}
        {{ $isCurrentProduct := and (eq .namespace $product) (in .versions $currentVersion) }}       
        {{ if not $isCurrentProduct }}
          {{ $scratch.Set "link" (print "/" .namespace "/" (index .versions 0) "/") }}
          
          {{ if and (eq $product "influxdb") (gt (len (findRE `^influxdb` .namespace)) 0) }}
            {{ $replacementPath := index (index $influxdbInfo .name) "path" }}
            {{ $altProductPage := $.GetPage ((replaceRE $pageRoot $replacementPath $.Page.RelPermalink) | replaceRE `\/$` "") }}
            
            {{/* ///////////// GET DEFAULT ALT PAGE AT SAME PATH //////////// */}}
            {{ if gt (len $altProductPage.Title) 0 }}
              {{ $scratch.Set "link" $altProductPage.RelPermalink }}

            {{/* ////////////// GET ALT LINKS FROM FRONTMATTER ////////////// */}}
            {{ else if (gt (len $altLinks) 0) }}
              {{ $productKey := index (index $influxdbInfo .name) "key" | default "" }}
              {{ if isset $altLinks $productKey }}
                {{ $scratch.Set "link" (index $altLinks $productKey) }}
              {{ end }}
            {{ end }}        
          {{ end }}

        {{ else }}
          {{ $scratch.Set "link" "" }}
        {{ end }}
        {{ $link := $scratch.Get "link" }}
        <li>
          <a href='{{ $link }}' {{ if $isCurrentProduct }}class="active"{{ end }}>{{ if .altname }}{{.altname}}{{ else }}{{ .name }}{{ end }}</a>
        </li>
      {{ end }}
    {{ end }}
  </ul>
</div>
