{{ $page := .page }}
{{ $menu := .menu }}

{{ define "recursiveMenu" }}
  {{ $menuContext := .menu }}
  {{ $currentPage := .currentPage }}
  {{ range $menuContext }}
    <li class="nav-category {{ if eq $currentPage.RelPermalink .URL }}active{{end}}">
      {{ if .HasChildren }}<a href="#" class="children-toggle {{ if or ($currentPage.IsMenuCurrent .Menu .) ($currentPage.HasMenuCurrent .Menu .) }}open{{end}}"></a>{{ end }}
      <a href='{{ cond (isset .Params "url") .Params.url .URL }}'>{{ .Name }}</a>
      {{ if .HasChildren }}
        <ul class="children {{ if or ($currentPage.IsMenuCurrent .Menu .) ($currentPage.HasMenuCurrent .Menu .) }}open{{end}}">
        {{ template "recursiveMenu" (dict "menu" .Children "currentPage" $currentPage) }}
        </ul>
      {{ end }}
    </li>
  {{ end }}
{{ end }}

{{ template "recursiveMenu" (dict "menu" .menu "currentPage" .page) }}
