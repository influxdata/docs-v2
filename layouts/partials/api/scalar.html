{{/*
  Scalar API Documentation Renderer

  Modern, accessible API documentation powered by Scalar.
  Features:
  - Dark/light theme support synchronized with site theme
  - InfluxData brand colors
  - Responsive layout
  - AI agent spec discovery via link[rel=alternate]
  - Download link for OpenAPI spec

  Required page params:
  - staticFilePath: Path to the OpenAPI specification file
*/}}

{{ $specPath := .Params.staticFilePath }}
{{ $specPathJSON := replace $specPath ".yaml" ".json" | replace ".yml" ".json" }}

{{/* Machine-readable links for AI agent discovery */}}
{{ if $specPath }}
<link rel="alternate" type="application/x-yaml" href="{{ $specPath | absURL }}" title="OpenAPI Specification (YAML)" />
<link rel="alternate" type="application/json" href="{{ $specPathJSON | absURL }}" title="OpenAPI Specification (JSON)" />
{{ end }}

<div class="api-reference-wrapper">
  {{/* Download link for the spec */}}
  {{ if $specPath }}
  <div class="api-spec-actions">
    <a href="{{ $specPath }}" class="btn api-spec-download" download>
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
        <path d="M8 12L3 7h3V2h4v5h3L8 12z"/>
        <path d="M1 14h14v2H1v-2z"/>
      </svg>
      Download OpenAPI Spec
    </a>
  </div>
  {{ end }}

  {{/* Scalar API Reference container */}}
  <div id="scalar-api-reference" class="api-reference-container"></div>
</div>

{{/* Load Scalar from CDN */}}
<script src="https://cdn.jsdelivr.net/npm/@scalar/api-reference@latest"></script>

<script>
(function() {
  'use strict';

  const specUrl = {{ $specPath | jsonify }};

  if (!specUrl) {
    console.error('[API Docs] No OpenAPI specification URL provided');
    document.getElementById('scalar-api-reference').innerHTML =
      '<p class="error">Error: No API specification configured for this page.</p>';
    return;
  }

  // Detect theme from document
  function getTheme() {
    return document.documentElement.dataset.theme === 'dark' ? 'dark' : 'light';
  }

  // Initialize Scalar when ready
  function initScalar() {
    if (typeof Scalar === 'undefined' || !Scalar.createApiReference) {
      console.error('[API Docs] Scalar library not loaded');
      return;
    }

    Scalar.createApiReference('#scalar-api-reference', {
      spec: { url: specUrl },
      theme: getTheme(),
      layout: 'modern',
      showSidebar: true,
      hideDownloadButton: false,
      hideModels: false,
      hideTestRequestButton: false,
      withDefaultFonts: false,
      customCss: `
        :root {
          --scalar-font: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          --scalar-font-code: 'Roboto Mono', 'SF Mono', Monaco, monospace;
          --scalar-color-1: #F63C41;
          --scalar-color-2: #d32f34;
          --scalar-color-accent: #F63C41;
          --scalar-radius: 4px;
          --scalar-radius-lg: 8px;
        }
      `
    });

    console.log('[API Docs] Scalar initialized with spec:', specUrl);
  }

  // Wait for Scalar to load, then initialize
  if (typeof Scalar !== 'undefined' && Scalar.createApiReference) {
    initScalar();
  } else {
    // Poll for Scalar availability
    let attempts = 0;
    const maxAttempts = 50;
    const checkInterval = setInterval(function() {
      attempts++;
      if (typeof Scalar !== 'undefined' && Scalar.createApiReference) {
        clearInterval(checkInterval);
        initScalar();
      } else if (attempts >= maxAttempts) {
        clearInterval(checkInterval);
        console.error('[API Docs] Scalar failed to load after', maxAttempts, 'attempts');
      }
    }, 100);
  }

  // Watch for theme changes
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.attributeName === 'data-theme') {
        // Scalar handles theme via CSS custom properties
        // Re-initialization not needed if CSS variables are used
        console.log('[API Docs] Theme changed to:', getTheme());
      }
    });
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });
})();
</script>

<style>
.api-reference-wrapper {
  width: 100%;
}

.api-spec-actions {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
  padding: 1rem 0;
  border-bottom: 1px solid var(--color-border, #e0e0e0);
}

.api-spec-download {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background-color: var(--color-bg-secondary, #f5f5f5);
  color: var(--color-text, #333);
  text-decoration: none;
  border-radius: 4px;
  font-size: 0.875rem;
  font-weight: 500;
  transition: background-color 0.2s, color 0.2s;
  border: 1px solid var(--color-border, #e0e0e0);
}

.api-spec-download:hover {
  background-color: #F63C41;
  color: white;
  border-color: #F63C41;
}

.api-reference-container {
  min-height: 600px;
}

/* Dark theme adjustments */
[data-theme="dark"] .api-spec-download {
  background-color: #2a2a2a;
  color: #e0e0e0;
  border-color: #444;
}

[data-theme="dark"] .api-spec-download:hover {
  background-color: #F63C41;
  color: white;
}

[data-theme="dark"] .api-spec-actions {
  border-color: #444;
}
</style>
