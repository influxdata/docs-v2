name: Test Code Blocks

# Manual-only workflow for testing code blocks in documentation.
# This workflow is informational and does not block pull requests.
# Run manually from Actions tab to validate code examples.

on:
  workflow_dispatch:
    inputs:
      products:
        description: 'Products to test (comma-separated: core,enterprise,telegraf,v2,cloud,cloud-dedicated,cloud-serverless,clustered)'
        required: false
        default: ''
      use_default_group:
        description: 'Use default group (core + telegraf) if no products specified'
        type: boolean
        required: false
        default: true

# Product to test script mapping
# Available products:
#   - core (influxdb3_core) â†’ influxdb3-core-pytest
#   - telegraf â†’ telegraf-pytest
#   - v2 â†’ v2-pytest
#   - cloud â†’ cloud-pytest
#   - cloud-dedicated â†’ cloud-dedicated-pytest
#   - cloud-serverless â†’ cloud-serverless-pytest
#   - clustered â†’ clustered-pytest
# Products without pytest services (skipped):
#   - enterprise â†’ content/influxdb3/enterprise
#   - v1 â†’ content/influxdb/v1
#   - explorer â†’ content/influxdb3/explorer

jobs:
  parse-inputs:
    name: Parse test inputs
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.parse.outputs.should-run }}
      test-products: ${{ steps.parse.outputs.test-products }}

    steps:
      - name: Parse product inputs
        id: parse
        run: |
          # Default product group: core + telegraf
          DEFAULT_PRODUCTS=("influxdb3_core" "telegraf")

          INPUT_PRODUCTS="${{ github.event.inputs.products }}"
          USE_DEFAULT="${{ github.event.inputs.use_default_group }}"

          if [[ -n "$INPUT_PRODUCTS" ]]; then
            # Parse comma-separated products and normalize names
            PRODUCTS=()
            IFS=',' read -ra PRODUCT_LIST <<< "$INPUT_PRODUCTS"
            for product in "${PRODUCT_LIST[@]}"; do
              # Trim whitespace and normalize product names
              product=$(echo "$product" | xargs)
              case "$product" in
                core|influxdb3_core|influxdb3-core)
                  PRODUCTS+=("influxdb3_core")
                  ;;
                enterprise|influxdb3_enterprise|influxdb3-enterprise)
                  PRODUCTS+=("influxdb3_enterprise")
                  ;;
                telegraf)
                  PRODUCTS+=("telegraf")
                  ;;
                v2|influxdb_v2)
                  PRODUCTS+=("v2")
                  ;;
                v1|influxdb_v1)
                  PRODUCTS+=("v1")
                  ;;
                cloud|influxdb_cloud)
                  PRODUCTS+=("cloud")
                  ;;
                cloud-dedicated|cloud_dedicated)
                  PRODUCTS+=("cloud-dedicated")
                  ;;
                cloud-serverless|cloud_serverless)
                  PRODUCTS+=("cloud-serverless")
                  ;;
                clustered)
                  PRODUCTS+=("clustered")
                  ;;
                explorer|influxdb3_explorer)
                  PRODUCTS+=("explorer")
                  ;;
                *)
                  echo "âš ï¸ Unknown product: $product (skipping)"
                  ;;
              esac
            done
          elif [[ "$USE_DEFAULT" == "true" ]]; then
            PRODUCTS=("${DEFAULT_PRODUCTS[@]}")
            echo "ðŸ“¦ Using default product group: ${PRODUCTS[*]}"
          else
            echo "âŒ No products specified and default group disabled"
            echo "should-run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ ${#PRODUCTS[@]} -eq 0 ]]; then
            echo "âŒ No valid products to test"
            echo "should-run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should-run=true" >> $GITHUB_OUTPUT

          # Convert to JSON array
          PRODUCTS_JSON=$(printf '%s\n' "${PRODUCTS[@]}" | jq -R . | jq -s -c .)
          echo "test-products=$PRODUCTS_JSON" >> $GITHUB_OUTPUT
          echo "âœ… Will run tests for: ${PRODUCTS[*]}"

  test-codeblocks:
    name: Test ${{ matrix.product }} code blocks
    needs: parse-inputs
    if: needs.parse-inputs.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        product: ${{ fromJson(needs.parse-inputs.outputs.test-products) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: |
          # Skip Cypress installation to speed up CI
          CYPRESS_INSTALL_BINARY=0 yarn install --frozen-lockfile

      - name: Build pytest Docker image
        run: |
          echo "Building influxdata/docs-pytest image..."
          docker build -t influxdata/docs-pytest:latest -f Dockerfile.pytest .

      - name: Setup test credentials (mock)
        run: |
          # Create mock .env.test files for CI
          # In production, these would be configured with actual credentials

          # InfluxDB 3 products
          mkdir -p content/influxdb3/core
          mkdir -p content/influxdb3/enterprise
          mkdir -p content/influxdb3/cloud-dedicated
          mkdir -p content/influxdb3/cloud-serverless
          mkdir -p content/influxdb3/clustered

          # InfluxDB v1/v2 products
          mkdir -p content/influxdb/cloud
          mkdir -p content/influxdb/v2
          mkdir -p content/influxdb/v1

          # Telegraf
          mkdir -p content/telegraf/v1

          # InfluxDB 3 Core
          cat > content/influxdb3/core/.env.test << 'EOF'
          # Mock credentials for CI testing
          INFLUX_HOST=http://localhost:8282
          INFLUX_TOKEN=mock_token_for_ci
          INFLUX_DATABASE=test_db
          EOF

          # InfluxDB 3 Enterprise
          cat > content/influxdb3/enterprise/.env.test << 'EOF'
          # Mock credentials for CI testing
          INFLUX_HOST=http://localhost:8181
          INFLUX_TOKEN=mock_token_for_ci
          INFLUX_DATABASE=test_db
          EOF

          # InfluxDB 3 Cloud products
          for product in cloud-dedicated cloud-serverless clustered; do
            cat > content/influxdb3/$product/.env.test << 'EOF'
          # Mock credentials for CI testing
          INFLUX_HOST=https://cluster.influxdata.com
          INFLUX_TOKEN=mock_token_for_ci
          INFLUX_DATABASE=test_db
          ACCOUNT_ID=mock_account
          CLUSTER_ID=mock_cluster
          EOF
          done

          # InfluxDB Cloud (v2)
          cat > content/influxdb/cloud/.env.test << 'EOF'
          # Mock credentials for CI testing
          INFLUX_HOST=https://cloud2.influxdata.com
          INFLUX_TOKEN=mock_token_for_ci
          INFLUX_ORG=mock_org
          INFLUX_BUCKET=mock_bucket
          EOF

          # InfluxDB v2
          cat > content/influxdb/v2/.env.test << 'EOF'
          # Mock credentials for CI testing
          INFLUX_HOST=http://localhost:8086
          INFLUX_TOKEN=mock_token_for_ci
          INFLUX_ORG=mock_org
          INFLUX_BUCKET=mock_bucket
          EOF

          # InfluxDB v1
          cat > content/influxdb/v1/.env.test << 'EOF'
          # Mock credentials for CI testing
          INFLUX_HOST=http://localhost:8086
          INFLUX_USERNAME=mock_user
          INFLUX_PASSWORD=mock_password
          EOF

          # Telegraf
          cat > content/telegraf/v1/.env.test << 'EOF'
          # Mock credentials for CI testing
          INFLUX_HOST=https://cloud2.influxdata.com
          INFLUX_TOKEN=mock_token_for_ci
          EOF

          echo "âœ… Mock test credentials created"

      - name: Run ${{ matrix.product }} code block tests
        id: test
        continue-on-error: true
        run: |
          echo "Running tests for ${{ matrix.product }}..."

          # Map product names to yarn test commands
          # Some products don't have pytest services yet - skip them gracefully
          case "${{ matrix.product }}" in
            influxdb3_core)
              TEST_CMD="yarn test:codeblocks:influxdb3_core"
              ;;
            influxdb3_enterprise)
              echo "âš ï¸ InfluxDB 3 Enterprise tests not yet configured - skipping"
              echo "test-status=skipped" >> $GITHUB_OUTPUT
              echo "exit-code=0" >> $GITHUB_OUTPUT
              exit 0
              ;;
            telegraf)
              TEST_CMD="yarn test:codeblocks:telegraf"
              ;;
            v2)
              TEST_CMD="yarn test:codeblocks:v2"
              ;;
            v1)
              echo "âš ï¸ InfluxDB v1 tests not yet configured - skipping"
              echo "test-status=skipped" >> $GITHUB_OUTPUT
              echo "exit-code=0" >> $GITHUB_OUTPUT
              exit 0
              ;;
            cloud)
              TEST_CMD="yarn test:codeblocks:cloud"
              ;;
            cloud-dedicated)
              TEST_CMD="yarn test:codeblocks:cloud-dedicated"
              ;;
            cloud-serverless)
              TEST_CMD="yarn test:codeblocks:cloud-serverless"
              ;;
            clustered)
              TEST_CMD="yarn test:codeblocks:clustered"
              ;;
            explorer)
              echo "âš ï¸ InfluxDB 3 Explorer tests not yet configured - skipping"
              echo "test-status=skipped" >> $GITHUB_OUTPUT
              echo "exit-code=0" >> $GITHUB_OUTPUT
              exit 0
              ;;
            *)
              echo "âŒ Unknown product: ${{ matrix.product }}"
              echo "test-status=failed" >> $GITHUB_OUTPUT
              echo "exit-code=1" >> $GITHUB_OUTPUT
              exit 1
              ;;
          esac

          # Run the test command
          $TEST_CMD || EXIT_CODE=$?

          # Capture exit code for reporting
          if [[ -n "$EXIT_CODE" ]]; then
            echo "test-status=failed" >> $GITHUB_OUTPUT
            echo "exit-code=$EXIT_CODE" >> $GITHUB_OUTPUT
          else
            echo "test-status=passed" >> $GITHUB_OUTPUT
            echo "exit-code=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate test summary
        if: always()
        run: |
          STATUS="${{ steps.test.outputs.test-status }}"
          case "$STATUS" in
            passed)
              STATUS_ICON="âœ… Passed"
              ;;
            skipped)
              STATUS_ICON="â­ï¸ Skipped"
              ;;
            *)
              STATUS_ICON="âŒ Failed"
              ;;
          esac

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Code Block Test Results - ${{ matrix.product }}

          **Status:** $STATUS_ICON
          **Product:** ${{ matrix.product }}
          **Exit Code:** ${{ steps.test.outputs.exit-code }}

          EOF

          if [[ "$STATUS" == "failed" ]]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          âš ï¸ **Note:** Code block tests require valid credentials configured in `.env.test` files.
          In CI, mock credentials are used which may cause some tests to fail.
          Review the test output above for specific failures.

          To test locally with real credentials:
          1. Create `.env.test` files in product directories
          2. Run `yarn test:codeblocks:<product>`
          EOF
          elif [[ "$STATUS" == "skipped" ]]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          â„¹ï¸ **Note:** This product does not have a pytest service configured yet.
          To add testing support, create a Docker Compose service in `compose.yaml`.
          EOF
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.product }}
          path: |
            test/shared/**
            pytest-*.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Report test status
        if: always()
        run: |
          STATUS="${{ steps.test.outputs.test-status }}"
          if [[ "$STATUS" == "failed" ]]; then
            echo "::warning::Code block tests failed for ${{ matrix.product }}"
          elif [[ "$STATUS" == "skipped" ]]; then
            echo "::notice::Tests skipped for ${{ matrix.product }} - pytest service not configured"
          fi
          # Always exit 0 - this workflow is informational only
          exit 0

  test-summary:
    name: Code Block Test Summary
    needs: [parse-inputs, test-codeblocks]
    if: always() && needs.parse-inputs.outputs.should-run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Check test results
        run: |
          # Report results (informational only)
          if [[ "${{ needs.test-codeblocks.result }}" == "failure" ]]; then
            echo "::warning::One or more code block test suites had failures"
            echo "âš ï¸ Some tests failed - review results above"
          elif [[ "${{ needs.test-codeblocks.result }}" == "success" ]]; then
            echo "âœ… All code block tests passed"
          else
            echo "â„¹ï¸ Tests were skipped or cancelled"
          fi
          # Always exit 0 - this workflow is informational only
          exit 0
