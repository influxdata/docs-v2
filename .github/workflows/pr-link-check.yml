name: Link Check PR Changes

on:
  pull_request:
    paths:
      - 'content/**/*.md'
      - 'data/**/*.yml'
      - 'layouts/**/*.html'
    types: [opened, synchronize, reopened]

jobs:
  link-check:
    name: Check links in affected files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Detect content changes
        id: detect
        run: |
          echo "ðŸ” Detecting changes between ${{ github.base_ref }} and ${{ github.sha }}"
          
          # For PRs, use the GitHub Files API to get changed files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "Using GitHub API to detect PR changes..."
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}/files" \
              | jq -r '.[].filename' > all_changed_files.txt
          else
            echo "Using git diff to detect changes..."
            git diff --name-only ${{ github.event.before }}..${{ github.sha }} > all_changed_files.txt
          fi
          
          # Filter for content markdown files
          CHANGED_FILES=$(grep '^content/.*\.md$' all_changed_files.txt || true)
          
          echo "ðŸ“ All changed files:"
          cat all_changed_files.txt
          echo ""
          echo "ðŸ“ Content markdown files:"
          echo "$CHANGED_FILES"
          
          if [[ -n "$CHANGED_FILES" ]]; then
            echo "âœ… Found $(echo "$CHANGED_FILES" | wc -l) changed content file(s)"
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "changed-content<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Check if any shared content files were modified
            SHARED_CHANGES=$(echo "$CHANGED_FILES" | grep '^content/shared/' || true)
            if [[ -n "$SHARED_CHANGES" ]]; then
              echo "has-shared-content=true" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Detected shared content changes: $SHARED_CHANGES"
            else
              echo "has-shared-content=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ No content changes detected"
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "has-shared-content=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Skip if no content changes
        if: steps.detect.outputs.has-changes == 'false'
        run: |
          echo "No content changes detected in this PR - skipping link check"
          echo "âœ… **No content changes detected** - link check skipped" >> $GITHUB_STEP_SUMMARY
          
      - name: Setup Node.js
        if: steps.detect.outputs.has-changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          
      - name: Install dependencies
        if: steps.detect.outputs.has-changes == 'true'
        run: yarn install --frozen-lockfile
        
      - name: Build Hugo site
        if: steps.detect.outputs.has-changes == 'true'
        run: npx hugo --minify
        
      - name: Download link-checker binary
        if: steps.detect.outputs.has-changes == 'true'
        run: |
          echo "Downloading link-checker binary from docs-v2 releases..."
          
          # Download from docs-v2's own releases (always accessible)
          curl -L -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -o link-checker-info.json \
            "https://api.github.com/repos/influxdata/docs-v2/releases/tags/link-checker-v1.3.1"
          
          # Extract download URL for linux binary
          DOWNLOAD_URL=$(jq -r '.assets[] | select(.name | test("link-checker.*linux")) | .url' link-checker-info.json)
          
          if [[ "$DOWNLOAD_URL" == "null" || -z "$DOWNLOAD_URL" ]]; then
            echo "âŒ No linux binary found in release"
            echo "Available assets:"
            jq -r '.assets[].name' link-checker-info.json
            exit 1
          fi
          
          echo "ðŸ“¥ Downloading: $DOWNLOAD_URL"
          curl -L -H "Accept: application/octet-stream" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -o link-checker "$DOWNLOAD_URL"
          
          chmod +x link-checker
          ./link-checker --version
        
      - name: Verify link checker config exists
        if: steps.detect.outputs.has-changes == 'true'
        run: |
          if [[ ! -f .ci/link-checker/production.lycherc.toml ]]; then
            echo "âŒ Configuration file .ci/link-checker/production.lycherc.toml not found"
            echo "Please copy production.lycherc.toml from docs-tooling/link-checker/"
            exit 1
          fi
          echo "âœ… Using configuration: .ci/link-checker/production.lycherc.toml"
        
      - name: Map changed content to public files
        if: steps.detect.outputs.has-changes == 'true'
        id: mapping
        run: |
          echo "Mapping changed content files to public HTML files..."
          
          # Create temporary file with changed content files
          echo "${{ steps.detect.outputs.changed-content }}" > changed-files.txt
          
          # Map content files to public files
          PUBLIC_FILES=$(cat changed-files.txt | xargs -r ./link-checker map --existing-only)
          
          if [[ -n "$PUBLIC_FILES" ]]; then
            echo "Found affected public files:"
            echo "$PUBLIC_FILES"
            echo "public-files<<EOF" >> $GITHUB_OUTPUT
            echo "$PUBLIC_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Count files for summary
            FILE_COUNT=$(echo "$PUBLIC_FILES" | wc -l)
            echo "file-count=$FILE_COUNT" >> $GITHUB_OUTPUT
          else
            echo "No public files found to check"
            echo "public-files=" >> $GITHUB_OUTPUT
            echo "file-count=0" >> $GITHUB_OUTPUT
          fi
        
      - name: Run link checker
        if: steps.detect.outputs.has-changes == 'true' && steps.mapping.outputs.public-files != ''
        id: link-check
        run: |
          echo "Checking links in ${{ steps.mapping.outputs.file-count }} affected files..."
          
          # Create temporary file with public files list
          echo "${{ steps.mapping.outputs.public-files }}" > public-files.txt
          
          # Run link checker with detailed JSON output
          set +e  # Don't fail immediately on error
          
          cat public-files.txt | xargs -r ./link-checker check \
            --config .ci/link-checker/production.lycherc.toml \
            --format json \
            --output link-check-results.json
          
          EXIT_CODE=$?
          
          if [[ -f link-check-results.json ]]; then
            # Parse results
            BROKEN_COUNT=$(jq -r '.summary.broken_count // 0' link-check-results.json)
            TOTAL_COUNT=$(jq -r '.summary.total_checked // 0' link-check-results.json)
            SUCCESS_RATE=$(jq -r '.summary.success_rate // 0' link-check-results.json)
            
            echo "broken-count=$BROKEN_COUNT" >> $GITHUB_OUTPUT
            echo "total-count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
            echo "success-rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
            
            if [[ $BROKEN_COUNT -gt 0 ]]; then
              echo "âŒ Found $BROKEN_COUNT broken links out of $TOTAL_COUNT total links"
              echo "check-result=failed" >> $GITHUB_OUTPUT
            else
              echo "âœ… All $TOTAL_COUNT links are valid"
              echo "check-result=passed" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Link check failed to generate results"
            echo "check-result=error" >> $GITHUB_OUTPUT
          fi
          
          exit $EXIT_CODE
          
      - name: Process and report results
        if: always() && steps.detect.outputs.has-changes == 'true' && steps.mapping.outputs.public-files != ''
        env:
          FILE_COUNT: ${{ steps.mapping.outputs.file-count }}
          TOTAL_COUNT: ${{ steps.link-check.outputs.total-count }}
          BROKEN_COUNT: ${{ steps.link-check.outputs.broken-count }}
          SUCCESS_RATE: ${{ steps.link-check.outputs.success-rate }}
          CHECK_RESULT: ${{ steps.link-check.outputs.check-result }}
        run: |
          if [[ -f link-check-results.json ]]; then
            # Generate summary header
            echo "## Link Check Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Files Checked | ${FILE_COUNT} |" >> $GITHUB_STEP_SUMMARY
            echo "| Total Links | ${TOTAL_COUNT} |" >> $GITHUB_STEP_SUMMARY
            echo "| Broken Links | ${BROKEN_COUNT} |" >> $GITHUB_STEP_SUMMARY
            echo "| Success Rate | ${SUCCESS_RATE}% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Create annotations and detailed report for broken links
            if [[ "${CHECK_RESULT}" == "failed" ]]; then
              echo "### Broken Links" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Severity | File | Broken URL | Error |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|------|------------|-------|" >> $GITHUB_STEP_SUMMARY

              # Parse broken links from JSON and create annotations + summary rows
              # The JSON structure contains files with their broken links
              jq -r '
                .files[]? |
                .path as $file |
                .links[]? |
                select(.status == "error" or .status == "warning") |
                {
                  file: $file,
                  url: .url,
                  status: (.status // "error"),
                  error: (.error // .status_code // "Unknown"),
                  line: (.line // 1)
                }
              ' link-check-results.json 2>/dev/null | jq -rs '.[]' 2>/dev/null | while read -r entry; do
                FILE=$(echo "$entry" | jq -r '.file')
                URL=$(echo "$entry" | jq -r '.url')
                STATUS=$(echo "$entry" | jq -r '.status')
                ERROR=$(echo "$entry" | jq -r '.error')
                LINE=$(echo "$entry" | jq -r '.line')

                # Map public path to content path for better annotations
                CONTENT_FILE=$(echo "$FILE" | sed 's|^public/|content/|' | sed 's|/index\.html$|/_index.md|')

                # Determine severity emoji and annotation type
                if [[ "$STATUS" == "error" ]]; then
                  EMOJI="ðŸ”´"
                  ANNOTATION_TYPE="error"
                else
                  EMOJI="ðŸŸ¡"
                  ANNOTATION_TYPE="warning"
                fi

                # Create GitHub annotation (points to content file for easy fixing)
                echo "::${ANNOTATION_TYPE} file=${CONTENT_FILE},line=${LINE}::Broken link: ${URL} - ${ERROR}"

                # Add row to summary table (escape pipes in URLs)
                SAFE_URL=$(echo "$URL" | sed 's/|/\\|/g' | head -c 80)
                echo "| ${EMOJI} ${STATUS} | \`${FILE}\` | ${SAFE_URL} | ${ERROR} |" >> $GITHUB_STEP_SUMMARY
              done

              # Fallback: Try alternative JSON structure if above produced no output
              if ! jq -e '.files' link-check-results.json >/dev/null 2>&1; then
                # Try flat structure: .broken_links[] or .results[]
                jq -r '(.broken_links // .results // [])[] |
                  "::error file=\(.file // .source_file // "unknown"),line=\(.line // 1)::Broken link: \(.url // .link) - \(.error // .message // "Unknown error")"' \
                  link-check-results.json 2>/dev/null || true

                jq -r '(.broken_links // .results // [])[] |
                  "| ðŸ”´ error | `\(.file // .source_file // "unknown")` | \(.url // .link) | \(.error // .message // "Unknown") |"' \
                  link-check-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
              fi

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "---" >> $GITHUB_STEP_SUMMARY
              echo "âŒ **Link check failed** - fix the broken links above before merging" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **All links are valid**" >> $GITHUB_STEP_SUMMARY
            fi

            # Add helpful tips
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ’¡ Troubleshooting Tips</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **404 errors**: The linked page doesn't exist. Check for typos or update the link." >> $GITHUB_STEP_SUMMARY
            echo "- **Relative links**: Use relative paths starting with \`/\` for internal links." >> $GITHUB_STEP_SUMMARY
            echo "- **Anchors**: Ensure heading anchors match the linked fragment exactly." >> $GITHUB_STEP_SUMMARY
            echo "- **External links**: External sites may be temporarily unavailable (shown as warnings)." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Link check could not complete** - no results file generated" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Upload detailed results
        if: always() && steps.detect.outputs.has-changes == 'true' && steps.mapping.outputs.public-files != ''
        uses: actions/upload-artifact@v4
        with:
          name: link-check-results
          path: |
            link-check-results.json
            changed-files.txt
            public-files.txt
          retention-days: 30